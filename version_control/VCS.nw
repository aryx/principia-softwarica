\documentclass[twocolumn, landscape]{report}

%******************************************************************************
% Prelude
%******************************************************************************
\newif\iffinal
\newif\ifverbose
\finaltrue\verbosefalse % see also other newif in Macros.tex

%------------------------------------------------------------------------------
%history: 
%------------------------------------------------------------------------------

%thx to LP, I changed for the better a few things:

%thx to codemap/codegraph/scheck:
% - TODO use cg to reduce backward deps, introduce globals.c, utils.c,
%   (harder to understand non layered code)
% - TODO use scheck to remove deadcode, dead prototypes, useless export
%   or mv as forward decl
%   (harder to understand big interface files)
% - TODO use cg to reduce number of globals by moving them closer to the
%   relevant file (or even function), better cluster the code
%   (harder to understand non functional code using lots of globals)

%thx to this manual, better understand VCS?:

%history LP-ization:
% - skeleton, mostly copy paste of Template.nw skeleton
% - put all content of files in the Extra section, via 'pfff -lpize'
%   which also now split in chunks!
%    * function, global, struct, enum, constant, macro(actually function)
%    * TODO ctor/dtor, dumper
%    * TODO [[xxx]] other fields, [[xxx]] extra fields
% - TODO read Extra section, identify concepts, first TOC
% - TODO distribute parts of the Extra section in the main file
% - TODO understand main(), LP split main, improve TOC
% - TODO understand main functions, LP split, cluster, improve TOC
% - TODO LP split the structures, use datalog for flow to field info
% - TODO nullify, boolify, errorify, enumify,  typeify,    scheckify, plan9ify
% - TODO aspecify advanced features! remove useless features
% - TODO add figures
% - TODO add explanations

%------------------------------------------------------------------------------
% Packages
%------------------------------------------------------------------------------

\usepackage{../docs/latex/noweb}
 \noweboptions{footnotesizecode,nomargintag}
 %note: allow chunk on different pages, less white space at bottom of pages
 \def\nwendcode{\endtrivlist \endgroup}
 \let\nwdocspar=\par
\usepackage{xspace}
\usepackage{verbatim}
%note: required by noweblatexpad for the \t \l \n in this file
\usepackage{fancyvrb}
\usepackage{url}
\iffinal
\usepackage{hyperref}
 \hypersetup{colorlinks=true}
\fi
\usepackage[pageref]{backref}
 \def\backref{{\footnotesize cited page(s)}~}
%\usepackage{cleveref} %\cref
%\usepackage{multirow}
\usepackage{booktabs} 
 \newcommand{\otoprule}{\midrule[\heavyrulewidth]}
\usepackage{graphicx}
%\usepackage{minitoc}

%------------------------------------------------------------------------------
% Macros
%------------------------------------------------------------------------------
\input{../docs/latex/Macros}

%------------------------------------------------------------------------------
% Config
%------------------------------------------------------------------------------
\allcodefalse
% used for forward decl, pragmas, func decl, extern decl, stats, #ifdef,
% debugging macros

\addtolength{\topmargin}{-.850in}
\addtolength{\textheight}{1.70in}


\begin{document}
%******************************************************************************
% Title
%******************************************************************************
\title{
{\Huge 
Principia Softwarica: The Version Control System [[XXX]]
}\\
{version 0.1}
}

\author{
Yoann Padioleau\\
\texttt{yoann.padioleau@gmail.com}\\
\\
with code from\\
???
}
\maketitle 

\onecolumn
\hrule
\input{../docs/latex/Copyright}
%\input{../docs/latex/CopyrightPlan9}
\hrule
\twocolumn

\begingroup
\hypersetup{linkcolor=blue}
% need to s/onecolumn/twocolumn in report.cls :) for \tableofcontents
\tableofcontents
\endgroup

%******************************************************************************
% Body
%******************************************************************************

\chapter{Introduction}

\section{Motivations}

The goal of this book is to present in full details the source code of
a version control system.
Why? Because I think you are a better programmer if
you fully understand how things work under the hood.

Here are a few questions I hope this book will answer:
\begin{itemize}
\end{itemize}


\section{The version control system, [[XXX]]}

% Chose camp, a mini darcs. Simple? Elegant? Arguably more powerful.
% < 10 000 LOC.
%% Can be good opportunity also to read some haskell code. Maybe can then
%% port the code to OCaml.

\section{Other version control systems}

Here are other candidates that were considered but ultimately discarded:
\begin{itemize}

\item RCS
% 24~000 LOC, but too limited, just one file, no branch, no concurrent work
% (and already 24 000 LOC, insane)

\item CVS
% 160 000 LOC, with rcs.c at 8000 LOC, hmm,
% concurrent, but branch is really tedious

\item git
% 489 000 LOC
% very good, but big codebase in C, and complicated (e.g. rebase)
% has an article in AOSA book 1 or 2
% first commit was small:
%  https://github.com/git/git/commit/e83c5163316f89bfbde7d9ab23ca2e25604af290
% also libgit2, LOC? share code with git?

\item mercurial
%mercurial (147 000 LOC, core = 84 000 LOC)
%   core of 1.0 is? maybe not that bad

\end{itemize}

% In the end I picked a mix between git and mercurial: git, but
% implemented in the language used for mercurial (Python).

%https://building-git.launchrock.com/
%https://blog.jcoglan.com/2017/02/12/the-myers-diff-algorithm-part-1/


%industry:
% - perforce
% - sourcesafe
% - bitkeeper
%other:
% - subversion (630 000 LOC, hmm)
%other DVCSs:
% - darcs 80 000 LOC (using literate haskell), maybe good candidate, simpler
%   model, arguably simpler than git (rebase for free?), some patch theory.
%   But code looks actually awful. Lots of boilerplate. Huge types.
%   Camp is a simplified version at 6300 LOC
% - gnu arch (aka tla 273 000 LOC)
% - bazaar (477 000 LOC)
%   https://www.jelmer.uk/pages/bzr-a-retrospective.html
% - monotone (99 000 LOC for 1.1)
%git alternate porcelain:
% - gitless, a better design for git, great paper:
%   http://people.csail.mit.edu/sperezde/pre-print-oopsla16.pdf
%   (can implement this design with dulwich?)
%mini:
% - http://benhoyt.com/writings/pygit/ 500 LOC to push to github
% - http://gitlet.maryrosecook.com/ mini git in Javascript, heavily
%   commented (but LP would be better)
% - pijul, initially in ocaml (3000 LOC), then in Rust, but seems to have 
%   a slow development
% - gg 7000 LOC, but no locking, no push, and requires external diff.
%   http://www-cs-students.stanford.edu/~blynn/gg/
%   this guy also wrote a book on Git "Git Magic"
%clones in other languages (all clones of git actually):
% - dulwich: git written in python (15000 LOC (without tests))
%   which includes some porcelain now (there is also another project
%   called gittle which is porcelain for dulwich).
%   Used by Google for some projects to provide bridge between
%   mercurial and git.
%   Originally created to offer bridge between bazaar and git by one
%   of bazaar maintainer. Based on python-git hack by James Westby.
% - git-go: git written in Go (but seems limited to archeology command)
% - JGit: git in Java
% - libgit: git in C, but reuse git code or new implem?
% - gat: git clone in haskell http://evan-tech.livejournal.com/254793.html
%   another one:
%   http://stefan.saasen.me/articles/git-clone-in-haskell-from-the-bottom-up/
% - ocaml-git: 15 000 LOC, but  heavily functorized (to support unix 
%   but also mirage), many dependencies (mstructs, cstruct, topkg, logs)
%   and seems to be only an API to access data. No support
%   for diffs; no merge; no porcelain.

%https://en.wikipedia.org/wiki/List_of_revision_control_software
%http://www.catb.org/esr/writings/version-control/version-control.html
%https://codewords.recurse.com/issues/two/git-from-the-inside-out
%http://eagain.net/articles/git-for-computer-scientists/
%https://stevebennett.me/2012/02/24/10-things-i-hate-about-git/
%Bram cohen vs torvalds on deep algo in git:
%http://www.wincent.com/a/about/wincent/weblog/archives/2007/07/a_look_back_bra.php

%future:
% - my semantic-vcs proposal!
%   related: https://www.semanticmerge.com/
% - gitless design  http://people.csail.mit.edu/sperezde/pre-print-oopsla16.pdf

%http://manishearth.github.io/blog/2017/03/05/understanding-git-filter-branch/

\section{Getting started}

\section{Requirements}

\section{About this document}
#include "docs/latex/About.nw"

\section{Copyright}

Most of this document is actually source code from XXX, so
those parts are copyright by YYY.
The prose is mine and is licensed under the GNU Free Documentation
License.

\section{Acknowledgments}






\chapter{Overview}

\section{VCS principles}

% See Misfits paper, great summary of essential purposes.

% First, store past versions. Can go back in time if made a mistake.
% Could get that with copy, but better organized, and storing
% deltas has efficiency implications. 

% Also by having delta
% and message associated with it help explore history. Git log, git
% blame are fantastic tool, even in single-user mode. To know
% code related to a line, the message of this patch, etc.
% Also in multi-user mode good to know the author, test plan, test
% files, coupled code, etc.
% I used it a lot to understand code at Facebook.

% Then when work in groups, useful to have way to work concurrently,
% to not pass his copy and wait for the "token". Concurrent
% techniques are lock, or better optimistic and later merge.

% Branches are also very useful. Work on different tasks, different
% branches. Can juggle between those.

% What brings distributed then? More convenient than centralized.
% Less imposing. Nice to have everything locally. Just more general.
% Can do centralized with distributed (e.g. "main" repo on github
% is the main thing to pull from).

% Finally github is fantastic. Easy to setup and start sharing work.

% ten innovations in the history of vcs:
% http://www.flourish.org/blog/?p=397
% http://www.flourish.org/2011/12/astonishments-ten-in-the-history-of-version-control/
% free easy hosting is in it? a la github?

% see Mercurial chapter in AOSA book.


\section{[[XXX]] services}

\section{Repository format}

\section{A toy session}

\section{Code organization}

\section{Software architecture}

%###############################################################################

\chapter{Core Data Structures}

% see 'dulwich in 5 min' pdf:
%  - basic obj read/write (tree, blog, tag, commit)
%  - pack (read/write)
%  - smart server/client???
%  - index (read/write)
%  - patch parsing/generation
%  - fastimport/fastexport

\chapter{[[main()]]}

\chapter{Repository}

\chapter{Commit}

\chapter{Branches}
% purpose: parallel development
% gitless records working version of files, so can easily switch branch!
% no problem if got uncommitted stuff in current dir or untracked file
% that conflicts with tracked file in another branch, it will be saved!
% in gitless, it really is like you had 2 separate dirs with 2
%  separate working versions!

\chapter{Pull and Push}


\chapter{Advanced Topics}

\chapter{Conclusion}

\appendix

\chapter{Debugging}

\chapter{Profiling}

\chapter{Error Management}

\chapter{Extra Code}

\ifallcode
#include "VCS_extra.nw"
\fi

%\chapter{Changelog}
%\label{sec:changelog}

% code via make loc = X LOC
% orig VCS.nw = XX, just lpized and few comments, ?? pages pdf
% now: =~ XX LOC so added XX LOE (Lines of explanations)
% vcs in ocaml: XX LOC (but still miss some advanced-topics features)

\chapter{Glossary}
\label{sec:glossary}

\begin{verbatim}
\end{verbatim}

\chapter*{Indexes}
\addcontentsline{toc}{section}{Index}

%\chapter{References} 
\addcontentsline{toc}{section}{References}

\bibliography{../docs/latex/Principia}
\bibliographystyle{alpha}

%******************************************************************************
% Postlude
%******************************************************************************

\end{document}
